<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MTF Data Dashboard</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      color: #333;
      line-height: 1.5;
    }
    
    h1 {
      color: #2c3e50;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #eee;
      padding-bottom: 0.5rem;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
    }
    
    select, input {
      margin: 0.25rem 0;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-width: 150px;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .summary, .stock-result {
      margin-top: 2rem;
      padding: 1.5rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .summary h3, .stock-result h3 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5rem;
    }
    
    #summaryList {
      list-style-type: none;
      padding-left: 0;
    }
    
    #summaryList li {
      padding: 0.5rem 0;
      border-bottom: 1px solid #eee;
    }
    
    #summaryList li:last-child {
      border-bottom: none;
    }
    
    .loading {
      display: none;
      margin: 1rem 0;
      font-style: italic;
      color: #666;
    }
    
    .error {
      color: #e74c3c;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      select, input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>MTF Data Search</h1>

  <div class="controls">
    <div class="control-group">
      <label for="yearSelect">Year:</label>
      <select id="yearSelect"></select>
    </div>

    <div class="control-group">
      <label for="monthSelect">Month:</label>
      <select id="monthSelect"></select>
    </div>

    <div class="control-group">
      <label for="dateSelect">Date:</label>
      <select id="dateSelect"></select>
    </div>

    <div class="control-group">
      <label for="stockInput">Search Stock:</label>
      <input list="stockList" id="stockInput" placeholder="Enter stock name" />
      <datalist id="stockList"></datalist>
    </div>
  </div>

  <div class="loading" id="loadingIndicator">Loading data...</div>
  
  <div class="summary" id="summaryBox">
    <h3>Summary</h3>
    <ul id="summaryList"></ul>
  </div>

  <div class="stock-result" id="stockBox">
    <h3>Stock Details</h3>
    <p><strong>Stock:</strong> <span id="stockName"></span></p>
    <p><strong>Summary:</strong> <span id="stockSummary"></span></p>
    <p><strong>Qty Fin (Cr):</strong> <span id="stockC"></span></p>
    <p><strong>Amt Fin (Cr):</strong> <span id="stockD"></span></p>
  </div>

  <script>
    // Configuration
    const FOLDER_PATH = 'output_data1';
    let currentData = null;
    
    /**
     * Shows the loading indicator
     */
    function showLoading() {
      document.getElementById('loadingIndicator').style.display = 'block';
    }
    
    /**
     * Hides the loading indicator
     */
    function hideLoading() {
      document.getElementById('loadingIndicator').style.display = 'none';
    }

    /**
     * Displays an error message in the summary box
     */
    function showError(message) {
      document.getElementById('summaryList').innerHTML = 
        `<li class="error">${message}</li>`;
    }
    
    /**
     * Populates a dropdown with the provided items
     */
    function populateDropdown(id, items) {
      const dropdown = document.getElementById(id);
      dropdown.innerHTML = '<option value="">--Select--</option>';
      
      if (items && items.length > 0) {
        items.forEach(item => {
          dropdown.innerHTML += `<option value="${item}">${item}</option>`;
        });
        console.log(`Populated ${id} with ${items.length} items`);
      } else {
        console.log(`No items to populate ${id}`);
      }
    }

    /**
     * Fetches and parses an index.json file
     */
    async function fetchIndexJson(path) {
      showLoading();
      try {
        const response = await fetch(`${path}/index.json`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log(`Index data for ${path}:`, data);
        
        if (!data.items || !Array.isArray(data.items)) {
          throw new Error('Invalid index.json format - missing items array');
        }
        
        return data.items;
      } catch (error) {
        console.error(`Failed to fetch index.json from ${path}:`, error);
        showError(`Could not load directory listing: ${error.message}`);
        return [];
      } finally {
        hideLoading();
      }
    }

    /**
     * Updates the years dropdown with available years
     */
    async function loadYears() {
      console.log('Loading years...');
      const years = await fetchIndexJson(FOLDER_PATH);
      populateDropdown('yearSelect', years);
    }

    /**
     * Updates the months dropdown based on selected year
     */
    async function loadMonths(year) {
      console.log(`Loading months for year ${year}...`);
      if (!year) return;
      
      const months = await fetchIndexJson(`${FOLDER_PATH}/${year}`);
      populateDropdown('monthSelect', months);
    }

    /**
     * Updates the dates dropdown based on selected year and month
     */
    async function loadDates(year, month) {
      console.log(`Loading dates for ${year}/${month}...`);
      if (!year || !month) return;
      
      const files = await fetchIndexJson(`${FOLDER_PATH}/${year}/${month}`);
      const dateFiles = files.filter(file => file.endsWith('.json') && file !== 'index.json');
      populateDropdown('dateSelect', dateFiles);
    }

    /**
     * Loads JSON data for the selected date
     */
    async function loadStockData(year, month, dateFile) {
      console.log(`Loading stock data for ${year}/${month}/${dateFile}...`);
      if (!year || !month || !dateFile) return;
      
      showLoading();
      try {
        const filePath = `${FOLDER_PATH}/${year}/${month}/${dateFile}`;
        const response = await fetch(filePath);
        
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('Stock data loaded:', data);
        
        // Store the loaded data
        currentData = data;
        
        // Update the UI with the loaded data
        displaySummary(data.summary || []);
        populateStockSearch(Object.keys(data.stocks || {}));
        clearStockDetails();
      } catch (error) {
        console.error('Error loading stock data:', error);
        showError(`Failed to load data: ${error.message}`);
      } finally {
        hideLoading();
      }
    }

    /**
     * Displays summary information
     */
    function displaySummary(summaryData) {
      const list = document.getElementById('summaryList');
      list.innerHTML = '';
      
      if (!summaryData || summaryData.length === 0) {
        list.innerHTML = '<li>No summary data available</li>';
        return;
      }
      
      for (const item of summaryData) {
        // Handle various data formats safely
        const particular = item.particular || 'Unknown';
        let amount = '-';
        
        if (item.amount_crores !== undefined) {
          if (typeof item.amount_crores === 'number') {
            amount = item.amount_crores.toLocaleString();
          } else {
            amount = item.amount_crores;
          }
        }
        
        list.innerHTML += `<li><strong>${particular}:</strong> â‚¹${amount} Cr</li>`;
      }
    }

    /**
     * Populates the stock search datalist
     */
    function populateStockSearch(stocks) {
      const datalist = document.getElementById('stockList');
      datalist.innerHTML = '';
      
      if (!stocks || stocks.length === 0) {
        return;
      }
      
      // Sort alphabetically
      stocks.sort().forEach(stock => {
        const option = document.createElement('option');
        option.value = stock;
        datalist.appendChild(option);
      });
      
      console.log(`Added ${stocks.length} stocks to search datalist`);
    }

    /**
     * Displays details for the selected stock
     */
    function displayStockDetails(stockName) {
      if (!stockName || !currentData || !currentData.stocks) {
        clearStockDetails();
        return;
      }
      
      const stock = currentData.stocks[stockName];
      
      if (!stock) {
        document.getElementById('stockName').textContent = stockName;
        document.getElementById('stockSummary').textContent = 'No data found';
        document.getElementById('stockC').textContent = '-';
        document.getElementById('stockD').textContent = '-';
        return;
      }
      
      document.getElementById('stockName').textContent = stockName;
      document.getElementById('stockSummary').textContent = stock.summary || '-';
      document.getElementById('stockC').textContent = 
        stock.total_c !== undefined ? stock.total_c.toFixed(2) : '-';
      document.getElementById('stockD').textContent = 
        stock.total_d !== undefined ? stock.total_d.toFixed(2) : '-';
    }

    /**
     * Clears the stock details display
     */
    function clearStockDetails() {
      document.getElementById('stockName').textContent = '-';
      document.getElementById('stockSummary').textContent = '-';
      document.getElementById('stockC').textContent = '-';
      document.getElementById('stockD').textContent = '-';
    }

    // Initialize when the DOM is fully loaded
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Initializing MTF Data Dashboard...');
      
      // Set up the Year dropdown change event
      document.getElementById('yearSelect').addEventListener('change', function() {
        const selectedYear = this.value;
        console.log(`Year selection changed to: ${selectedYear}`);
        
        // Reset dependent dropdowns
        document.getElementById('monthSelect').innerHTML = '<option value="">--Select--</option>';
        document.getElementById('dateSelect').innerHTML = '<option value="">--Select--</option>';
        clearStockDetails();
        
        if (selectedYear) {
          loadMonths(selectedYear);
        }
      });
      
      // Set up the Month dropdown change event
      document.getElementById('monthSelect').addEventListener('change', function() {
        const selectedYear = document.getElementById('yearSelect').value;
        const selectedMonth = this.value;
        console.log(`Month selection changed to: ${selectedMonth}`);
        
        // Reset dependent dropdown
        document.getElementById('dateSelect').innerHTML = '<option value="">--Select--</option>';
        clearStockDetails();
        
        if (selectedYear && selectedMonth) {
          loadDates(selectedYear, selectedMonth);
        }
      });
      
      // Set up the Date dropdown change event
      document.getElementById('dateSelect').addEventListener('change', function() {
        const selectedYear = document.getElementById('yearSelect').value;
        const selectedMonth = document.getElementById('monthSelect').value;
        const selectedDate = this.value;
        console.log(`Date selection changed to: ${selectedDate}`);
        
        if (selectedYear && selectedMonth && selectedDate) {
          loadStockData(selectedYear, selectedMonth, selectedDate);
        }
      });
      
      // Set up the stock search input event
      document.getElementById('stockInput').addEventListener('input', function() {
        displayStockDetails(this.value);
      });
      
      // Load the initial years data
      loadYears();
    });
  </script>
</body>
</html>
