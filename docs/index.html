<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MTF Data Dashboard</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      padding: 2rem;
      max-width: 1200px;
      margin: 0 auto;
      color: #333;
      line-height: 1.5;
    }
    
    h1 {
      color: #2c3e50;
      margin-bottom: 1.5rem;
      border-bottom: 2px solid #eee;
      padding-bottom: 0.5rem;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
    }
    
    select, input {
      margin: 0.25rem 0;
      padding: 0.5rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      min-width: 150px;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .summary, .stock-result {
      margin-top: 2rem;
      padding: 1.5rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .summary h3, .stock-result h3 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5rem;
    }
    
    #summaryList {
      list-style-type: none;
      padding-left: 0;
    }
    
    #summaryList li {
      padding: 0.5rem 0;
      border-bottom: 1px solid #eee;
    }
    
    #summaryList li:last-child {
      border-bottom: none;
    }
    
    .charts-section {
      margin-top: 2rem;
    }

    .chart-container {
      margin-top: 2rem;
      padding: 1.5rem;
      border: 1px solid #ddd;
      border-radius: 8px;
      background-color: #f9f9f9;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    
    .timeline-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding: 1rem;
      background-color: #f0f0f0;
      border-radius: 6px;
    }

    button {
      padding: 0.5rem 1rem;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 1.5rem;
    }

    button:hover {
      background-color: #2980b9;
    }

    canvas {
      width: 100% !important;
      max-height: 400px;
    }
    
    .stock-chart-container {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid #eee;
    }
    
    .loading {
      display: none;
      margin: 1rem 0;
      font-style: italic;
      color: #666;
    }
    
    .error {
      color: #e74c3c;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      body {
        padding: 1rem;
      }
      
      .controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      select, input {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <h1>MTF Data Search</h1>

  <div class="controls">
    <div class="control-group">
      <label for="yearSelect">Year:</label>
      <select id="yearSelect"></select>
    </div>

    <div class="control-group">
      <label for="monthSelect">Month:</label>
      <select id="monthSelect"></select>
    </div>

    <div class="control-group">
      <label for="dateSelect">Date:</label>
      <select id="dateSelect"></select>
    </div>

    <div class="control-group">
      <label for="stockInput">Search Stock:</label>
      <input list="stockList" id="stockInput" placeholder="Enter stock name" />
      <datalist id="stockList"></datalist>
    </div>
  </div>

  <div class="loading" id="loadingIndicator">Loading data...</div>
  
  <div class="summary" id="summaryBox">
    <h3>Summary</h3>
    <ul id="summaryList"></ul>
  </div>

  <div class="stock-result" id="stockBox">
    <h3>Stock Details</h3>
    <p><strong>Stock:</strong> <span id="stockName"></span></p>
    <p><strong>Summary:</strong> <span id="stockSummary"></span></p>
    <p><strong>Qty Fin (Cr):</strong> <span id="stockC"></span></p>
    <p><strong>Amt Fin (Cr):</strong> <span id="stockD"></span></p>
    <div class="stock-chart-container">
      <canvas id="individualStockChart"></canvas>
    </div>
  </div>
  
  <div class="charts-section">
    <h2>Data Visualization</h2>
    
    <div class="chart-container">
      <h3>Summary Chart</h3>
      <canvas id="summaryChart"></canvas>
    </div>
    
    <div class="chart-container">
      <h3>Stock Details Chart</h3>
      <p>Top 10 stocks by amount financed</p>
      <canvas id="stockChart"></canvas>
    </div>
  </div>

  <div class="charts-section">
    <div class="chart-container" id="timelineAnalysisContainer">
      <h3>Timeline Analysis</h3>
      
      <div class="timeline-controls">
        <div class="control-group">
          <label for="startYearSelect">Start Year:</label>
          <select id="startYearSelect"></select>
        </div>
        <div class="control-group">
          <label for="startMonthSelect">Start Month:</label>
          <select id="startMonthSelect"></select>
        </div>
        <div class="control-group">
          <label for="startDateSelect">Start Date (Optional):</label>
          <select id="startDateSelect">
            <option value="">All Dates</option>
          </select>
        </div>
        <div class="control-group">
          <label for="endYearSelect">End Year:</label>
          <select id="endYearSelect"></select>
        </div>
        <div class="control-group">
          <label for="endMonthSelect">End Month:</label>
          <select id="endMonthSelect"></select>
        </div>
        <div class="control-group">
          <label for="endDateSelect">End Date (Optional):</label>
          <select id="endDateSelect">
            <option value="">All Dates</option>
          </select>
        </div>
        <div class="control-group">
          <label for="timelineStockSelect">Filter Stock (Optional):</label>
          <select id="timelineStockSelect">
            <option value="">All Stocks</option>
          </select>
        </div>
        <div class="control-group">
          <button id="loadTimelineBtn">Load Timeline</button>
        </div>
      </div>
      
      <canvas id="timelineChart"></canvas>
    </div>
  </div>

<script>
// Global variables
const FOLDER_PATH = './output_data1'; // Path to your data folder
let currentData = null;
let summaryChart = null;
let stockChart = null;
let individualStockChart = null;
let timelineChartInstance = null;

// Utility functions
function showLoading() {
  document.getElementById('loadingIndicator').style.display = 'block';
}

function hideLoading() {
  document.getElementById('loadingIndicator').style.display = 'none';
}

function showError(message) {
  const errorDiv = document.createElement('div');
  errorDiv.className = 'error';
  errorDiv.textContent = message;
  document.body.insertBefore(errorDiv, document.body.firstChild);
  
  setTimeout(() => {
    if (errorDiv.parentNode) {
      errorDiv.parentNode.removeChild(errorDiv);
    }
  }, 5000);
}

// Populate dropdown helper
function populateDropdown(id, items, defaultText = '--Select--') {
  const dropdown = document.getElementById(id);
  dropdown.innerHTML = `<option value="">${defaultText}</option>`;
  
  if (items && items.length > 0) {
    items.forEach(item => {
      dropdown.innerHTML += `<option value="${item}">${item}</option>`;
    });
  }
}

// Load years on page load
async function loadYears() {
  try {
    showLoading();
    const response = await fetch(`${FOLDER_PATH}/index.json`);
    
    if (!response.ok) {
      throw new Error('Cannot load years data. Please check if the data folder exists and is accessible.');
    }
    
    const data = await response.json();
    populateDropdown('yearSelect', data.items);
    populateDropdown('startYearSelect', data.items);
    populateDropdown('endYearSelect', data.items);
    
  } catch (error) {
    console.error('Error loading years:', error);
    showError(`Error loading years: ${error.message}`);
  } finally {
    hideLoading();
  }
}

// Load months for selected year
async function loadMonths(year, targetId = 'monthSelect') {
  try {
    showLoading();
    const response = await fetch(`${FOLDER_PATH}/${year}/index.json`);
    
    if (!response.ok) {
      throw new Error(`Cannot load months for year ${year}`);
    }
    
    const data = await response.json();
    populateDropdown(targetId, data.items);
    
  } catch (error) {
    console.error('Error loading months:', error);
    showError(`Error loading months: ${error.message}`);
  } finally {
    hideLoading();
  }
}

// Load dates for selected year/month
async function loadDates(year, month, targetId = 'dateSelect') {
  try {
    showLoading();
    const response = await fetch(`${FOLDER_PATH}/${year}/${month}/index.json`);
    
    if (!response.ok) {
      throw new Error(`Cannot load dates for ${year}/${month}`);
    }
    
    const data = await response.json();
    const dateFiles = data.items.filter(file => file.endsWith('.json') && file !== 'index.json');
    
    if (targetId.includes('Date')) {
      populateDropdown(targetId, dateFiles, 'All Dates');
    } else {
      populateDropdown(targetId, dateFiles);
    }
    
  } catch (error) {
    console.error('Error loading dates:', error);
    showError(`Error loading dates: ${error.message}`);
  } finally {
    hideLoading();
  }
}

// Load stock data for specific date
async function loadStockData(year, month, date) {
  try {
    showLoading();
    const filePath = `${FOLDER_PATH}/${year}/${month}/${date}`;
    const response = await fetch(filePath);
    
    if (!response.ok) {
      throw new Error(`No data available for ${year}/${month}/${date}`);
    }
    
    const data = await response.json();
    currentData = data;
    
    // Display summary
    displaySummary(data.summary || []);
    
    // Populate stock autocomplete
    populateStockAutocomplete(data.stocks || {});
    
    // Create charts
    createSummaryChart(data.summary || []);
    createStockChart(data.stocks || {});
    
    // Clear stock details
    clearStockDetails();
    
  } catch (error) {
    console.error('Error loading stock data:', error);
    showError(`Error loading data: ${error.message}`);
  } finally {
    hideLoading();
  }
}

// Display summary data
function displaySummary(summaryData) {
  const summaryList = document.getElementById('summaryList');
  summaryList.innerHTML = '';
  
  if (!summaryData || summaryData.length === 0) {
    summaryList.innerHTML = '<li>No summary data available</li>';
    return;
  }
  
  summaryData.forEach(item => {
    const li = document.createElement('li');
    li.innerHTML = `<strong>${item.particular || 'N/A'}:</strong> ₹${(item.amount_crores || 0).toLocaleString()} Cr`;
    summaryList.appendChild(li);
  });
}

// Populate stock autocomplete
function populateStockAutocomplete(stocks) {
  const stockList = document.getElementById('stockList');
  stockList.innerHTML = '';
  
  Object.keys(stocks).forEach(stockName => {
    const option = document.createElement('option');
    option.value = stockName;
    stockList.appendChild(option);
  });
}

// Display stock details
function displayStockDetails(stockName) {
  if (!currentData || !currentData.stocks || !stockName) {
    clearStockDetails();
    return;
  }
  
  const stock = currentData.stocks[stockName];
  if (!stock) {
    clearStockDetails();
    return;
  }
  
  document.getElementById('stockName').textContent = stockName;
  document.getElementById('stockSummary').textContent = stock.Summary || 'N/A';
  document.getElementById('stockC').textContent = (stock.Quantity_in_crores || 0).toLocaleString();
  document.getElementById('stockD').textContent = (stock.Amount_in_crores || 0).toLocaleString();
  
  // Create individual stock chart
  createIndividualStockChart(stockName, stock);
}

// Clear stock details
function clearStockDetails() {
  document.getElementById('stockName').textContent = '';
  document.getElementById('stockSummary').textContent = '';
  document.getElementById('stockC').textContent = '';
  document.getElementById('stockD').textContent = '';
  
  if (individualStockChart) {
    individualStockChart.destroy();
    individualStockChart = null;
  }
}

// Create summary chart
function createSummaryChart(summaryData) {
  const ctx = document.getElementById('summaryChart');
  
  if (summaryChart) {
    summaryChart.destroy();
  }
  
  if (!summaryData || summaryData.length === 0) {
    return;
  }
  
  const labels = summaryData.map(item => item.particular || 'Unknown');
  const data = summaryData.map(item => item.amount_crores || 0);
  
  summaryChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Amount (Cr)',
        data: data,
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Amount (Cr)'
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `₹${context.parsed.y.toLocaleString()} Cr`;
            }
          }
        }
      }
    }
  });
}

// Create stock chart
function createStockChart(stocks) {
  const ctx = document.getElementById('stockChart');
  
  if (stockChart) {
    stockChart.destroy();
  }
  
  if (!stocks || Object.keys(stocks).length === 0) {
    return;
  }
  
  // Get top 10 stocks by amount
  const stockArray = Object.entries(stocks)
    .map(([name, data]) => ({
      name: name,
      amount: data.Amount_in_crores || 0
    }))
    .sort((a, b) => b.amount - a.amount)
    .slice(0, 10);
  
  const labels = stockArray.map(item => item.name);
  const data = stockArray.map(item => item.amount);
  
  stockChart = new Chart(ctx, {
    type: 'horizontalBar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Amount Financed (Cr)',
        data: data,
        backgroundColor: 'rgba(255, 99, 132, 0.6)',
        borderColor: 'rgba(255, 99, 132, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Amount (Cr)'
          }
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `₹${context.parsed.x.toLocaleString()} Cr`;
            }
          }
        }
      }
    }
  });
}

// Create individual stock chart
function createIndividualStockChart(stockName, stockData) {
  const ctx = document.getElementById('individualStockChart');
  
  if (individualStockChart) {
    individualStockChart.destroy();
  }
  
  const chartData = {
    labels: ['Quantity (Cr)', 'Amount (Cr)'],
    datasets: [{
      label: stockName,
      data: [stockData.Quantity_in_crores || 0, stockData.Amount_in_crores || 0],
      backgroundColor: ['rgba(75, 192, 192, 0.6)', 'rgba(255, 159, 64, 0.6)'],
      borderColor: ['rgba(75, 192, 192, 1)', 'rgba(255, 159, 64, 1)'],
      borderWidth: 1
    }]
  };
  
  individualStockChart = new Chart(ctx, {
    type: 'bar',
    data: chartData,
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.label}: ${context.parsed.y.toLocaleString()}`;
            }
          }
        }
      }
    }
  });
}

// Timeline functions
function populateTimelineStockFilter() {
  const stockSelect = document.getElementById('timelineStockSelect');
  stockSelect.innerHTML = '<option value="">All Stocks</option>';
  
  if (currentData && currentData.stocks) {
    const sortedStocks = Object.keys(currentData.stocks).sort();
    sortedStocks.forEach(stock => {
      const option = document.createElement('option');
      option.value = stock;
      option.textContent = stock;
      stockSelect.appendChild(option);
    });
  }
}

async function loadTimelineData(startYear, startMonth, startDate, endYear, endMonth, endDate, selectedStock) {
  try {
    showLoading();
    
    const timelineData = [];
    const stockTimelineData = [];
    
    // For simplicity, this example loads data for the specified range
    // You would need to implement the actual date range iteration logic here
    
    if (selectedStock && stockTimelineData.length > 0) {
      createStockTimelineChart(stockTimelineData, selectedStock);
    } else if (!selectedStock && timelineData.length > 0) {
      createTimelineChart(timelineData);
    } else {
      throw new Error('No data found for the selected criteria');
    }
    
  } catch (error) {
    console.error('Error loading timeline data:', error);
    showError(`Timeline error: ${error.message}`);
  } finally {
    hideLoading();
  }
}

function createTimelineChart(timelineData) {
  const ctx = document.getElementById('timelineChart');
  
  if (timelineChartInstance) {
    timelineChartInstance.destroy();
  }
  
  // Implementation for timeline chart
  timelineChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: []
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: false
        }
      }
    }
  });
}

function createStockTimelineChart(stockTimelineData, stockName) {
  const ctx = document.getElementById('timelineChart');
  
  if (timelineChartInstance) {
    timelineChartInstance.destroy();
  }
  
  // Implementation for stock timeline chart
  timelineChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: []
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: false
        }
      }
    }
  });
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
  // Load initial data
  loadYears();
  
  // Year selection
  document.getElementById('yearSelect').addEventListener('change', function() {
    const selectedYear = this.value;
    document.getElementById('monthSelect').innerHTML = '<option value="">--Select--</option>';
    document.getElementById('dateSelect').innerHTML = '<option value="">--Select--</option>';
    
    if (selectedYear) {
      loadMonths(selectedYear);
    }
  });
  
  // Month selection
  document.getElementById('monthSelect').addEventListener('change', function() {
    const selectedYear = document.getElementById('yearSelect').value;
    const selectedMonth = this.value;
    document.getElementById('dateSelect').innerHTML = '<option value="">--Select--</option>';
    
    if (selectedYear && selectedMonth) {
      loadDates(selectedYear, selectedMonth);
    }
  });
  
  // Date selection
  document.getElementById('dateSelect').addEventListener('change', function() {
    const selectedYear = document.getElementById('yearSelect').value;
    const selectedMonth = document.getElementById('monthSelect').value;
    const selectedDate = this.value;
    
    if (selectedYear && selectedMonth && selectedDate) {
      loadStockData(selectedYear, selectedMonth, selectedDate);
      setTimeout(() => populateTimelineStockFilter(), 1000);
    }
  });
  
  // Stock search
  document.getElementById('stockInput').addEventListener('input', function() {
    displayStockDetails(this.value);
  });
  
  // Timeline controls
  document.getElementById('startYearSelect').addEventListener('change', function() {
    const selectedYear = this.value;
    document.getElementById('startMonthSelect').innerHTML = '<option value="">--Select--</option>';
    document.getElementById('startDateSelect').innerHTML = '<option value="">All Dates</option>';
    
    if (selectedYear) {
      loadMonths(selectedYear, 'startMonthSelect');
    }
  });
  
  document.getElementById('startMonthSelect').addEventListener('change', function() {
    const selectedYear = document.getElementById('startYearSelect').value;
    const selectedMonth = this.value;
    document.getElementById('startDateSelect').innerHTML = '<option value="">All Dates</option>';
    
    if (selectedYear && selectedMonth) {
      loadDates(selectedYear, selectedMonth, 'startDateSelect');
    }
  });
  
  document.getElementById('endYearSelect').addEventListener('change', function() {
    const selectedYear = this.value;
    document.getElementById('endMonthSelect').innerHTML = '<option value="">--Select--</option>';
    document.getElementById('endDateSelect').innerHTML = '<option value="">All Dates</option>';
    
    if (selectedYear) {
      loadMonths(selectedYear, 'endMonthSelect');
    }
  });
  
  document.getElementById('endMonthSelect').addEventListener('change', function() {
    const selectedYear = document.getElementById('endYearSelect').value;
    const selectedMonth = this.value;
    document.getElementById('endDateSelect').innerHTML = '<option value="">All Dates</option>';
    
    if (selectedYear && selectedMonth) {
      loadDates(selectedYear, selectedMonth, 'endDateSelect');
    }
  });
  
  // Timeline load button
  document.getElementById('loadTimelineBtn').addEventListener('click', function() {
    const startYear = document.getElementById('startYearSelect').value;
    const startMonth = document.getElementById('startMonthSelect').value;
    const startDate = document.getElementById('startDateSelect').value || null;
    const endYear = document.getElementById('endYearSelect').value;
    const endMonth = document.getElementById('endMonthSelect').value;
    const endDate = document.getElementById('endDateSelect').value || null;
    const selectedStock = document.getElementById('timelineStockSelect').value;
    
    if (startYear && startMonth && endYear && endMonth) {
      loadTimelineData(startYear, startMonth, startDate, endYear, endMonth, endDate, selectedStock);
    } else {
      alert('Please select at least start and end year/month');
    }
  });
});
</script>
</body>
</html>
