<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MTF Data Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2rem;
    }
    select, input {
      margin: 0.5rem;
      padding: 0.5rem;
    }
    .summary, .stock-result {
      margin-top: 2rem;
      padding: 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <h1>MTF Data Search</h1>

  <label for="yearSelect">Year:</label>
  <select id="yearSelect"></select>

  <label for="monthSelect">Month:</label>
  <select id="monthSelect"></select>

  <label for="dateSelect">Date:</label>
  <select id="dateSelect"></select>

  <br/>

  <label for="stockInput">Search Stock:</label>
  <input list="stockList" id="stockInput" placeholder="Enter stock name" />
  <datalist id="stockList"></datalist>

  <div class="summary" id="summaryBox">
    <h3>Summary</h3>
    <ul id="summaryList"></ul>
  </div>

  <div class="stock-result" id="stockBox">
    <h3>Stock Details</h3>
    <p><strong>Stock:</strong> <span id="stockName"></span></p>
    <p><strong>Summary:</strong> <span id="stockSummary"></span></p>
    <p><strong>Qty Fin (Cr):</strong> <span id="stockC"></span></p>
    <p><strong>Amt Fin (Cr):</strong> <span id="stockD"></span></p>
  </div>

  <script>
    const months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];

    function populateDropdown(id, items) {
      const dropdown = document.getElementById(id);
      dropdown.innerHTML = `<option value="">--Select--</option>`;
      items.forEach(item => {
        dropdown.innerHTML += `<option value="${item}">${item}</option>`;
      });
    }

    async function fetchJsonList(path) {
      try {
        const res = await fetch(path);
        if (!res.ok) return [];
        const text = await res.text();
        const parser = new DOMParser();
        const html = parser.parseFromString(text, 'text/html');
        return Array.from(html.querySelectorAll('a'))
          .map(a => a.getAttribute('href'))
          .filter(name => name.endsWith('.json'));
      } catch (err) {
        console.error(err);
        return [];
      }
    }

  async function listFolder(path) {
  try {
    const res = await fetch(path);
    const text = await res.text();
    const parser = new DOMParser();
    const html = parser.parseFromString(text, 'text/html');
    return Array.from(html.querySelectorAll('a'))
      .map(a => a.getAttribute('href'))
      .filter(name => name && !name.startsWith('http')) // filter out external URLs
      .map(name => name.replace(/\/$/, '')) // remove trailing slash
      .filter(name => name !== '..' && name !== '../'); // filter parent links
  } catch (err) {
    console.error(err);
    return [];
  }
}

    async function updateYears() {
      const years = await listFolder('output_data/');
      populateDropdown('yearSelect', years);
    }

    async function updateMonths(year) {
      if (!year) return;
      const months = await listFolder(`output_data/${year}/`);
      populateDropdown('monthSelect', months);
    }

    async function updateDates(year, month) {
      if (!year || !month) return;
      const files = await listFolder(`output_data/${year}/${month}/`);
      const jsonFiles = files.filter(name => name.endsWith('.json'));
      populateDropdown('dateSelect', jsonFiles);
    }

    async function loadDateData(year, month, file) {
      try {
        const res = await fetch(`output_data/${year}/${month}/${file}`);
        if (!res.ok) throw new Error('Failed to fetch data file');
        const data = await res.json();

        currentData = data;
        showSummary(data.summary);
        populateStockList(Object.keys(data.stocks || {}));
        clearStockDetails();
      } catch (err) {
        alert('Error loading data: ' + err.message);
      }
    }

    function showSummary(summaryData) {
      const list = document.getElementById('summaryList');
      list.innerHTML = '';
      if (!summaryData) return;
      for (let item of summaryData) {
        list.innerHTML += `<li>${item.particular}: â‚¹${item.amount_crores} Cr</li>`;
      }
    }

    function populateStockList(stocks) {
      const list = document.getElementById('stockList');
      list.innerHTML = '';
      stocks.forEach(stock => {
        const opt = document.createElement('option');
        opt.value = stock;
        list.appendChild(opt);
      });
    }

    function showStockDetails(name) {
      const stock = currentData?.stocks?.[name];
      if (!stock) return clearStockDetails();

      document.getElementById('stockName').textContent = name;
      document.getElementById('stockSummary').textContent = stock.summary || '-';
      document.getElementById('stockC').textContent = stock.total_c?.toFixed(2) || '-';
      document.getElementById('stockD').textContent = stock.total_d?.toFixed(2) || '-';
    }

    function clearStockDetails() {
      document.getElementById('stockName').textContent = '';
      document.getElementById('stockSummary').textContent = '';
      document.getElementById('stockC').textContent = '';
      document.getElementById('stockD').textContent = '';
    }

    document.getElementById('yearSelect').addEventListener('change', async function () {
      await updateMonths(this.value);
      populateDropdown('dateSelect', []);
      clearStockDetails();
    });

    document.getElementById('monthSelect').addEventListener('change', async function () {
      const year = document.getElementById('yearSelect').value;
      await updateDates(year, this.value);
      clearStockDetails();
    });

    document.getElementById('dateSelect').addEventListener('change', async function () {
      const year = document.getElementById('yearSelect').value;
      const month = document.getElementById('monthSelect').value;
      await loadDateData(year, month, this.value);
    });

    document.getElementById('stockInput').addEventListener('input', function () {
      showStockDetails(this.value);
    });

    // Initialize
    let currentData = null;
    updateYears();
  </script>
</body>
</html>
