import os
import csv
import json

data_dir = "fetch_mtf/data/extracted"
output = {}

for root, dirs, files in os.walk(data_dir):
    for file in files:
        if file.endswith(".csv"):
            year = os.path.basename(os.path.dirname(root))
            if year not in output:
                output[year] = {}
            file_path = os.path.join(root, file)
            with open(file_path, encoding="utf-8") as f:
                reader = csv.reader(f)
                rows = list(reader)
                
                report_line = rows[0][0]
                if "Reporting date" in report_line:
                    date_str = report_line.split("Reporting date")[-1].strip()
                else:
                    continue

                date_key = f"{date_str}"
                if date_key not in output[year]:
                    output[year][date_key] = {
                        "summary": [],
                        "stocks": {}
                    }

                # Summary section (rows 2â€“5)
                # Summary section (rows 4 to 7)
                summary_rows = []
                for i in range(4, 8):
                    try:
                        part = rows[i][1].strip()
                        amount_lakhs = float(rows[i][2].replace(",", "").strip())
                        amount_crores = round(amount_lakhs / 100, 2)
                        summary_rows.append({
                            "particular": part,
                            "amount_crores": amount_crores
                        })
                    except (IndexError, ValueError):
                        continue

                # Only include summary if at least one value is non-zero
                if any(row["amount_crores"] > 0 for row in summary_rows):
                    output[year][date_key]["summary"] = summary_rows
                else:
                    output[year][date_key]["summary"] = []


                # Find stock section
                stock_start_index = None
                for i, row in enumerate(rows):
                    if row and row[0].strip().lower() == "symbol":
                        stock_start_index = i + 1
                        break

                if stock_start_index is None:
                    continue

                # Stock rows
                for row in rows[stock_start_index:]:
                    if len(row) < 4:
                        continue
                    stock = row[0].strip()
                    summary = row[1].strip()
                    try:
                        Quantity_in_crores = float(row[2].replace(",", "")) / 100
                        Amount_in_crores = float(row[3].replace(",", "")) / 100
                    except ValueError:
                        continue

                    if stock not in output[year][date_key]["stocks"]:
                        output[year][date_key]["stocks"][stock] = {
                            "summary": summary,
                            "Quantity_in_crores": 0,
                            "Amount_in_crores": 0
                        }
                    output[year][date_key]["stocks"][stock]["Quantity_in_crores"] += Quantity_in_crores
                    output[year][date_key]["stocks"][stock]["Amount_in_crores"] += Amount_in_crores

# Save the final JSON
os.makedirs("docs", exist_ok=True)
with open("docs/mtf_data.json", "w", encoding="utf-8") as f:
    json.dump(output, f, indent=2)

</html>
